function [ W, PC, r ] = fit_cylinder( X )
%FIT_CYLINDER 
%
%
% author: Luca Magri 2018
% reference: Fitting 3D data with a Cylinder - David Eberly
%
% C point on axis
% r radius of cylinder
% W axis unit direction
% 6 parameters


% subtract mean
t = mean(X,2);
X = bsxfun(@minus, X,t);

%[u,v]=eig(X*X');
%[~,t] = max(diag(v));
%W = normc(u(:,t))
W_start = icosaedron();
I = icosphere(3);
W_start = I.Vertices';
W_star = [0;0;1];
figure;
scatter3(X(1,:),X(2,:),X(3,:))
hold all;
for i = 1:size(W_start,2)
    [error(i), PC, r] = G_cylinder(normc(W_start(:,i)),X);
    [~,t] = min(error);
end  
W = W_start(:,t);
 M =[W;PC;r]; 

    col_map = brewermap(10,'Set2');
    display_cylinder(X,M,col_map(1,:))
 
   

end


%%

function [error_geo] = cost_cylinder(a,X)
            %a(1) azimuth
            %a(2) elevation
        [W(1),W(2),W(3)] = sph2cart(a(1),a(2),1);  
        [error_geo, ~, ~] = G_cylinder(W,X);
end
%%
function [error, PC, r] = G_cylinder(W,X)
% evaluates the function G(W) and generate the corresponding PC and r

n = size(X,2);
W = normc(W);
P = eye(3) - W*W';
S = [0 -W(3), W(2); W(3),0, -W(1); -W(2), W(1), 0];
Y = P*X;
A = (Y*Y')./n;
A_hat = S*A*S';
L = sum(Y.*Y,1); % squared Length
aL = mean(L);   % averaged Length

B = sum(bsxfun(@times, L, Y),2)/n;
PC = (A_hat*B)/trace(A_hat*A); % point on the axis of the cylinder


% radius: mean distance from PC of the projected points
diff = bsxfun(@minus,PC,Y);
norm_diff_sq = sum(diff.*diff,1); % squared distance
r1 =  sqrt(mean(norm_diff_sq))

% error 
%res = L-aL -   (2 .*  Y'*PC)';
error = 0;
rSqr = 0;
for i = 1: n
    term = L(i)- aL - 2* Y(:,i)'*PC;
    error = error + term*term; 
    diff = PC -Y(i);
    rSqr = rSqr + diff'*diff;
end
error = error/n;
rSqr = rSqr/n;
r = sqrt(rSqr)
%error = mean(res)
%error = mean(res2)
% geometric distance
%XC = bsxfun(@minus,X,PC);
%res_geo = abs(sqrt(sum( (XC'*P)'.* XC))-r);
%error_geo = mean(res_geo);

end


%%
function W_start = icosaedron()
W_start = [-0.9904         0    0.1380;
   -0.9877   -0.1331    0.0822;
   -0.9877    0.1331    0.0822;
   -0.9664   -0.1328    0.2201;
   -0.9664    0.1328    0.2201;
   -0.9619         0    0.2733;
   -0.9511   -0.2629    0.1625;
   -0.9511    0.2629    0.1625;
   -0.9243   -0.1317    0.3582;
   -0.9243    0.1317    0.3582;
   -0.9162   -0.2641    0.3013;
   -0.9162    0.2641    0.3013;
   -0.9150         0    0.4034;
   -0.9130   -0.3996    0.0823;
   -0.9130    0.3996    0.0823;
   -0.8910   -0.3862    0.2387;
   -0.8910    0.3862    0.2387;
   -0.8649   -0.1312    0.4844;
   -0.8649    0.1312    0.4844;
   -0.8627   -0.2599    0.4339;
   -0.8627    0.2599    0.4339;
   -0.8507         0    0.5257;
   -0.8439   -0.3836    0.3750;
   -0.8439    0.3836    0.3750;
   -0.8402   -0.5193    0.1564;
   -0.8402    0.5193    0.1564;
   -0.8090   -0.5000    0.3090;
   -0.8090    0.5000    0.3090;
   -0.7926   -0.2130    0.5713;
   -0.7926    0.2130    0.5713;
   -0.7838   -0.0811    0.6156;
   -0.7838    0.0811    0.6156;
   -0.7835   -0.3462    0.5161;
   -0.7835    0.3462    0.5161;
   -0.7802   -0.6202    0.0811;
   -0.7802    0.6202    0.0811;
   -0.7587   -0.6068    0.2371;
   -0.7587    0.6068    0.2371;
   -0.7579   -0.4684    0.4540;
   -0.7579    0.4684    0.4540;
   -0.7113         0    0.7029;
   -0.7071   -0.6015    0.3717;
   -0.7071    0.6015    0.3717;
   -0.7023   -0.2960    0.6474;
   -0.7023    0.2960    0.6474;
   -0.7020   -0.1606    0.6938;
   -0.7020    0.1606    0.6938;
   -0.6938   -0.7020    0.1606;
   -0.6938    0.7020    0.1606;
   -0.6882   -0.4253    0.5878;
   -0.6882    0.4253    0.5878;
   -0.6474   -0.7023    0.2960;
   -0.6474    0.7023    0.2960;
   -0.6466   -0.5643    0.5134;
   -0.6466    0.5643    0.5134;
   -0.6202   -0.0811    0.7802;
   -0.6202    0.0811    0.7802;
   -0.6156   -0.7838    0.0811;
   -0.6156    0.7838    0.0811;
   -0.6068   -0.2371    0.7587;
   -0.6068    0.2371    0.7587;
   -0.6015   -0.3717    0.7071;
   -0.6015    0.3717    0.7071;
   -0.5878   -0.6882    0.4253;
   -0.5878    0.6882    0.4253;
   -0.5713   -0.7926    0.2130;
   -0.5713    0.7926    0.2130;
   -0.5643   -0.5134    0.6466;
   -0.5643    0.5134    0.6466;
   -0.5257         0    0.8507;
   -0.5193   -0.1564    0.8402;
   -0.5193    0.1564    0.8402;
   -0.5161   -0.7835    0.3462;
   -0.5161    0.7835    0.3462;
   -0.5134   -0.6466    0.5643;
   -0.5134    0.6466    0.5643;
   -0.5000   -0.3090    0.8090;
   -0.5000    0.3090    0.8090;
   -0.4844   -0.8649    0.1312;
   -0.4844    0.8649    0.1312;
   -0.4684   -0.4540    0.7579;
   -0.4684    0.4540    0.7579;
   -0.4540   -0.7579    0.4684;
   -0.4540    0.7579    0.4684;
   -0.4339   -0.8627    0.2599;
   -0.4339    0.8627    0.2599;
   -0.4253   -0.5878    0.6882;
   -0.4253    0.5878    0.6882;
   -0.3996   -0.0823    0.9130;
   -0.3996    0.0823    0.9130;
   -0.3862   -0.2387    0.8910;
   -0.3862    0.2387    0.8910;
   -0.3836   -0.3750    0.8439;
   -0.3836    0.3750    0.8439;
   -0.3750   -0.8439    0.3836;
   -0.3750    0.8439    0.3836;
   -0.3717   -0.7071    0.6015;
   -0.3717    0.7071    0.6015;
   -0.3582   -0.9243    0.1317;
   -0.3582    0.9243    0.1317;
   -0.3462   -0.5161    0.7835;
   -0.3462    0.5161    0.7835;
   -0.3090   -0.8090    0.5000;
   -0.3090    0.8090    0.5000;
   -0.3013   -0.9162    0.2641;
   -0.3013    0.9162    0.2641;
   -0.2960   -0.6474    0.7023;
   -0.2960    0.6474    0.7023;
   -0.2664         0    0.9639;
   -0.2641   -0.3013    0.9162;
   -0.2641    0.3013    0.9162;
   -0.2629   -0.1625    0.9511;
   -0.2629    0.1625    0.9511;
   -0.2599   -0.4339    0.8627;
   -0.2599    0.4339    0.8627;
   -0.2387   -0.8910    0.3862;
   -0.2387    0.8910    0.3862;
   -0.2371   -0.7587    0.6068;
   -0.2371    0.7587    0.6068;
   -0.2201   -0.9664    0.1328;
   -0.2201    0.9664    0.1328;
   -0.2130   -0.5713    0.7926;
   -0.2130    0.5713    0.7926;
   -0.1625   -0.9511    0.2629;
   -0.1625    0.9511    0.2629;
   -0.1606   -0.6938    0.7020;
   -0.1606    0.6938    0.7020;
   -0.1564   -0.8402    0.5193;
   -0.1564    0.8402    0.5193;
   -0.1331   -0.0822    0.9877;
   -0.1331    0.0822    0.9877;
   -0.1328   -0.2201    0.9664;
   -0.1328    0.2201    0.9664;
   -0.1317   -0.3582    0.9243;
   -0.1317    0.3582    0.9243;
   -0.1312   -0.4844    0.8649;
   -0.1312    0.4844    0.8649;
   -0.0823   -0.9130    0.3996;
   -0.0823    0.9130    0.3996;
   -0.0822   -0.9877    0.1331;
   -0.0822    0.9877    0.1331;
   -0.0811   -0.7802    0.6202;
   -0.0811    0.7802    0.6202;
   -0.0811   -0.6156    0.7838;
   -0.0811    0.6156    0.7838;
         0   -0.9639    0.2664;
         0   -0.8507    0.5257;
         0   -0.7029    0.7113;
         0   -0.5257    0.8507;
         0   -0.4034    0.9150;
         0   -0.2733    0.9619;
         0   -0.1380    0.9904;
         0         0    1.0000;
         0    0.1380    0.9904;
         0    0.2733    0.9619;
         0    0.4034    0.9150;
         0    0.5257    0.8507;
         0    0.7029    0.7113;
         0    0.8507    0.5257;
         0    0.9639    0.2664;
    0.0811   -0.6156    0.7838;
    0.0811    0.6156    0.7838;
    0.0811   -0.7802    0.6202;
    0.0811    0.7802    0.6202;
    0.0822   -0.9877    0.1331;
    0.0822    0.9877    0.1331;
    0.0823   -0.9130    0.3996;
    0.0823    0.9130    0.3996;
    0.1312   -0.4844    0.8649;
    0.1312    0.4844    0.8649;
    0.1317   -0.3582    0.9243;
    0.1317    0.3582    0.9243;
    0.1328   -0.2201    0.9664;
    0.1328    0.2201    0.9664;
    0.1331   -0.0822    0.9877;
    0.1331    0.0822    0.9877;
    0.1564   -0.8402    0.5193;
    0.1564    0.8402    0.5193;
    0.1606   -0.6938    0.7020;
    0.1606    0.6938    0.7020;
    0.1625   -0.9511    0.2629;
    0.1625    0.9511    0.2629;
    0.2130   -0.5713    0.7926;
    0.2130    0.5713    0.7926;
    0.2201   -0.9664    0.1328;
    0.2201    0.9664    0.1328;
    0.2371   -0.7587    0.6068;
    0.2371    0.7587    0.6068;
    0.2387   -0.8910    0.3862;
    0.2387    0.8910    0.3862;
    0.2599   -0.4339    0.8627;
    0.2599    0.4339    0.8627;
    0.2629   -0.1625    0.9511;
    0.2629    0.1625    0.9511;
    0.2641   -0.3013    0.9162;
    0.2641    0.3013    0.9162;
    0.2664         0    0.9639;
    0.2960   -0.6474    0.7023;
    0.2960    0.6474    0.7023;
    0.3013   -0.9162    0.2641;
    0.3013    0.9162    0.2641;
    0.3090   -0.8090    0.5000;
    0.3090    0.8090    0.5000;
    0.3462   -0.5161    0.7835;
    0.3462    0.5161    0.7835;
    0.3582   -0.9243    0.1317;
    0.3582    0.9243    0.1317;
    0.3717   -0.7071    0.6015;
    0.3717    0.7071    0.6015;
    0.3750   -0.8439    0.3836;
    0.3750    0.8439    0.3836;
    0.3836   -0.3750    0.8439;
    0.3836    0.3750    0.8439;
    0.3862   -0.2387    0.8910;
    0.3862    0.2387    0.8910;
    0.3996   -0.0823    0.9130;
    0.3996    0.0823    0.9130;
    0.4253   -0.5878    0.6882;
    0.4253    0.5878    0.6882;
    0.4339   -0.8627    0.2599;
    0.4339    0.8627    0.2599;
    0.4540   -0.7579    0.4684;
    0.4540    0.7579    0.4684;
    0.4684   -0.4540    0.7579;
    0.4684    0.4540    0.7579;
    0.4844   -0.8649    0.1312;
    0.4844    0.8649    0.1312;
    0.5000   -0.3090    0.8090;
    0.5000    0.3090    0.8090;
    0.5134   -0.6466    0.5643;
    0.5134    0.6466    0.5643;
    0.5161   -0.7835    0.3462;
    0.5161    0.7835    0.3462;
    0.5193   -0.1564    0.8402;
    0.5193    0.1564    0.8402;
    0.5257         0    0.8507;
    0.5643   -0.5134    0.6466;
    0.5643    0.5134    0.6466;
    0.5713   -0.7926    0.2130;
    0.5713    0.7926    0.2130;
    0.5878   -0.6882    0.4253;
    0.5878    0.6882    0.4253;
    0.6015   -0.3717    0.7071;
    0.6015    0.3717    0.7071;
    0.6068   -0.2371    0.7587;
    0.6068    0.2371    0.7587;
    0.6156   -0.7838    0.0811;
    0.6156    0.7838    0.0811;
    0.6202   -0.0811    0.7802;
    0.6202    0.0811    0.7802;
    0.6466   -0.5643    0.5134;
    0.6466    0.5643    0.5134;
    0.6474   -0.7023    0.2960;
    0.6474    0.7023    0.2960;
    0.6882   -0.4253    0.5878;
    0.6882    0.4253    0.5878;
    0.6938   -0.7020    0.1606;
    0.6938    0.7020    0.1606;
    0.7020   -0.1606    0.6938;
    0.7020    0.1606    0.6938;
    0.7023   -0.2960    0.6474;
    0.7023    0.2960    0.6474;
    0.7071   -0.6015    0.3717;
    0.7071    0.6015    0.3717;
    0.7113         0    0.7029;
    0.7579   -0.4684    0.4540;
    0.7579    0.4684    0.4540;
    0.7587   -0.6068    0.2371;
    0.7587    0.6068    0.2371;
    0.7802   -0.6202    0.0811;
    0.7802    0.6202    0.0811;
    0.7835   -0.3462    0.5161;
    0.7835    0.3462    0.5161;
    0.7838   -0.0811    0.6156;
    0.7838    0.0811    0.6156;
    0.7926   -0.2130    0.5713;
    0.7926    0.2130    0.5713;
    0.8090   -0.5000    0.3090;
    0.8090    0.5000    0.3090;
    0.8402   -0.5193    0.1564;
    0.8402    0.5193    0.1564;
    0.8439   -0.3836    0.3750;
    0.8439    0.3836    0.3750;
    0.8507         0    0.5257;
    0.8627   -0.2599    0.4339;
    0.8627    0.2599    0.4339;
    0.8649   -0.1312    0.4844;
    0.8649    0.1312    0.4844;
    0.8910   -0.3862    0.2387;
    0.8910    0.3862    0.2387;
    0.9130   -0.3996    0.0823;
    0.9130    0.3996    0.0823;
    0.9150         0    0.4034;
    0.9162   -0.2641    0.3013;
    0.9162    0.2641    0.3013;
    0.9243   -0.1317    0.3582;
    0.9243    0.1317    0.3582;
    0.9511   -0.2629    0.1625;
    0.9511    0.2629    0.1625;
    0.9619         0    0.2733;
    0.9664   -0.1328    0.2201;
    0.9664    0.1328    0.2201;
    0.9877   -0.1331    0.0822;
    0.9877    0.1331    0.0822;
    0.9904         0    0.1380;]';
end
